const proyectoParams=new URLSearchParams(window.location.search),proyecto=Object.fromEntries(proyectoParams.entries());let tagsFiltro=["-1"],tagsSeleccionados=[],idiomaSeleccionado="es";const dims={height:700,width:500};let res,origen,setColor=!1,grafico=1;margin={top:10,right:100,bottom:0,left:100},step=14;const crearElemento=(t,e,r,a)=>{const n=document.createElement(t);return e&&(n.id=e),r&&n.classList.add(r),a&&(n.textContent=a),n},agregarOpcionesSelect=(t,e)=>{e.forEach(e=>{const r=document.createElement("option");r.value=e.value,r.textContent=e.label,t.appendChild(r)})},manejarCambioIdioma=(t,e)=>{t.addEventListener("change",(function(){const t=this.value;idiomaSeleccionado=t,e()}))},manejarCambioGrafico=(t,e)=>{t.addEventListener("change",(function(){const t=this.value;grafico=t,e()}))},crearBotonesCurso=(t,e)=>{t.forEach(t=>{const r=crearElemento("button",t.id,"filter-button",`${t.numero} ${t.descripcion}`);r.classList.toggle("activo"),r.addEventListener("click",()=>{r.classList.toggle("activo"),e(),r.style.backgroundColor=r.classList.contains("activo")?color(r.id):"rgba(0, 0, 0, 0.5)"}),document.getElementById("navbar").appendChild(r)})},manejarBotonTag=t=>{const e=crearElemento("button",null,"filter-button","Filtrar por Tag");e.classList.toggle("activo"),e.addEventListener("click",()=>{const e=res.anoCurso.flatMap(t=>t.asignaturas.flatMap(t=>t.tags.map(t=>t.descripcion))),r=[...new Set(e)];t(r)}),document.getElementById("navbar").appendChild(e)},manejarToggleNavbar=()=>{const t=crearElemento("button","toggle-navbar","toggle-button","☰");document.getElementById("navbar").appendChild(t),t.addEventListener("click",()=>{const t=document.getElementById("navbar");t.classList.contains("hidden")?(t.classList.remove("hidden"),setTimeout(()=>{t.style.opacity=1},10)):(t.style.opacity=0,setTimeout(()=>{t.classList.add("hidden")},500))})};async function obtenerGrafo(t){try{const a="http://localhost/UpTask_MVC/public/index.php/api/grafo?id="+t,n=await fetch(a),o=await n.json();origen=o.respuesta.curso,res={...origen};const s=document.getElementById("navbar");manejarToggleNavbar();const i=crearElemento("select","language-select","filter-button");agregarOpcionesSelect(i,[{value:"es",label:"Español"},{value:"eu",label:"Euskera"},{value:"en",label:"Inglés"}]),manejarCambioIdioma(i,()=>InicializarGrafo(res)),s.appendChild(i);const c=crearElemento("select","grafo-select","filter-button");agregarOpcionesSelect(c,[{value:1,label:"Grafo"},{value:2,label:"Circunferencia"},{value:4,label:"Árbol"}]),manejarCambioGrafico(c,()=>InicializarGrafo(res)),s.appendChild(c),manejarBotonTag(mostrarTags),e=res.anoCurso,r=filtrarCursos,e.forEach(t=>{const e=crearElemento("button",t.id,"filter-button",`${t.numero} ${t.descripcion}`);e.classList.toggle("activo"),e.addEventListener("click",()=>{e.classList.toggle("activo"),r(),e.style.backgroundColor=e.classList.contains("activo")?color(e.id):"rgba(0, 0, 0, 0.5)"}),document.getElementById("navbar").appendChild(e)}),InicializarGrafo(res)}catch(t){console.error("Error al obtener los datos del grafo:",t)}var e,r}async function InicializarGrafo(t){var e=[];t.anoCurso.forEach(t=>{const r={...t,id:t.id};e.push(r)});insertargrafo(e,t)}function obtenerBotonesActivos(){return Array.from(document.querySelectorAll(".activo")).map(t=>t.id)}function arc(t){const e=t.source.y,r=t.target.y,a=Math.abs(r-e)/1.7;return`M${margin.left},${e}A${a},${a} 0,0,${e<r?1:0} ${margin.left},${r}`}function rec(t){return`M${t.source.x},${t.source.y} L${t.target.x},${t.target.y}`}function arc2(t){const e=t.source.y,r=t.target.y,a=Math.abs(r-e)/1.7;return`M${margin.left},${e}A${a},${a} 0,0,${e<r?1:0} ${margin.left},${r}`}function insertargrafo(t,e){const r=obtenerBotonesActivos();if("-1"!==tagsFiltro[0]){const e=t.flatMap(t=>t.asignaturas.filter(t=>{const e=r.includes(t.cursoID),a=t.tags&&t.tags.some(t=>tagsFiltro.includes(t.descripcion));return e&&a}));v=e.flatMap(t=>[a(t)])}else v=t.flatMap(t=>t.asignaturas.filter(t=>r.includes(t.cursoID))).map(t=>a(t));function a(t){if(t.info&&t.info.length>0){const e=t.info.find(t=>t.idioma===idiomaSeleccionado);if(e&&e.nombre)return e.nombre;const r=t.info[0];if(r&&r.nombre)return r.nombre}return t.asignatura}function n(t){if(t.info&&t.info.length>0){const e=t.info.find(t=>t.idioma===idiomaSeleccionado);if(e&&e.nombre)return e.sigla;const r=t.info[0];if(r&&r.nombre)return r.sigla}return t.asignatura}dx=3*d3.max(v,t=>t.length)+d3.max(v,t=>t.length)/1,height=(t.flatMap(t=>t.asignaturas).length-1)*step+margin.top+margin.bottom;const o=t.flatMap(t=>t.asignaturas.map(e=>{const r=n(e),o=n(e);return{id:e.id,sigla:r,nombre:a(e),semestre:e.semestre,sourceLinks:[],targetLinks:[],group:e.cursoID,sigla2:o,tags:e.tags,curso:t.numero}})),s=[],i=new Map(o.map(t=>[t.id,t])),c=t.flatMap(t=>t.asignaturas.flatMap(t=>t.relaciones.map(t=>({source:i.get(t.id_asignatura1),target:i.get(t.id_asignatura2),value:t.descripcion,color:t.color})))).filter(t=>void 0!==t.target);for(const t of c){const{source:e,target:r,value:a}=t;e.sourceLinks.push(t),r.targetLinks.push(t)}const l={nodes:o,links:c};escalax=d3.scaleLinear().domain([0,dx]).range([0,margin.left]),d3.select(".panel").select("svg").remove(),d3.select(".canvas").select("svg").remove(),d3.select;const d=d3.select(".panel").append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${dims.width} ${dims.height}`).attr("preserveAspectRatio","xMidYMid meet"),u=d3.select(".canvas").append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${dims.width} ${dims.height}`).attr("preserveAspectRatio","xMidYMid meet");u.append("style").text("\n    .hover path {\n      stroke: transparent;\n      \n      \n    }\n    .hover marker-end{\n      stroke: transparent;\n    }\n    .hover text {\n      fill: #ccc;\n    }\n    .hover g.primary text {\n      fill: black;\n      font-weight: bold;\n    }\n    .hover g.secondary text {\n      fill: #333;\n      opacity: 1;\n    }\n    .hover path.primary {\n      stroke: #333;\n      stroke-opacity: 1;\n      \n    }\n    .hover  path.secondary {\n    \n      opacity: 0.3;\n    }\n\n   .hover  path:not(.primary):not(.secondary) {\n      marker-end: none;\n    }\n  ");const p=u.append("g"),g=d3.scalePoint().domain(l.nodes.map(t=>t.id).sort(d3.ascending)).range([margin.top,height-margin.bottom]);if(!setColor){color=d3.scaleOrdinal().domain(l.nodes.map(t=>t.group).sort(d3.ascending)).range(d3.schemeCategory10),setColor=!0;document.querySelectorAll(".filter-button").forEach(t=>{const e=t.id,r=color(e);t.style.backgroundColor=r})}const f=p.append("g").attr("font-family","sans-serif").attr("font-size",8).attr("text-anchor","end").selectAll("g").data(l.nodes).enter().append("g").attr("transform",t=>`translate(${t.x=dx}, ${t.y=g(t.id)})`).attr("año",t=>t.curso);f.append("text").attr("x",-6).attr("class","prueba").attr("dy","0.35em").attr("fill",t=>d3.lab(color(t.group)).darker(2)).text(t=>t.nombre),f.append("circle").attr("r",3).attr("fill",t=>color(t.group));const m=p.insert("g","*").attr("fill","none").attr("class","relacion").attr("stroke-opacity",.6).attr("stroke-width",1.5).selectAll("path").data(l.links).enter().append("path").attr("stroke",t=>(t.source.group,t.target.group,color(t.source.group))).attr("d",arc).attr("transform",`translate(${dx-margin.left},0)`).attr("marker-end",t=>`url(#arrow-${t.source.group}-${t.target.group})`);m.each((function(t){const e=t.source.group===t.target.group?color(t.source.group):color(t.target.group);p.append("defs").append("marker").attr("id",`arrow-${t.source.group}-${t.target.group}`).attr("viewBox","0 0 10 10").attr("refX",16).attr("refY",5).attr("markerWidth",20).attr("markerHeight",5).attr("orient","auto-start-reverse").append("path").attr("d","M 0 0 L 10 5 L 0 10 z").attr("fill",e)}));const h=p.insert("g","*").attr("fill","none").attr("class","relacion").attr("stroke-opacity",.6).attr("stroke-width",1.5).selectAll("path").data(s).enter().append("path").attr("stroke",t=>t.source.group===t.target.group?color(t.source.group):color(t.target.group)).attr("d",arc2).attr("transform",`translate(${dx-margin.left},0)`),y=p.append("g").attr("fill","none").attr("pointer-events","all").selectAll("rect").data(l.nodes).enter().append("rect").attr("width",margin.left+40).attr("height",step).attr("y",t=>g(t.id)-step/2).attr("x",dx-margin.left).on("mouseover",(function(t){u.classed("hover",!0),f.classed("primary",e=>e===t),f.classed("secondary",e=>e.sourceLinks.some(e=>e.target===t)||e.targetLinks.some(e=>e.source===t)),m.classed("primary",e=>e.source===t||e.target===t).filter(".primary").raise()})).on("mouseout",t=>{u.classed("hover",!1),f.classed("primary",!1),f.classed("secondary",!1),m.classed("primary",!1).order()}).on("click",(function(t){miFuncionExterna(t,d,color,s)}));if(1==grafico)imprimirTodosNodos(e,d,color);else if(2==grafico)imprimirNodos(e,d,color);else if(3==grafico)updateGraph(u,o,f,m,h,y,p,dims,margin,rec);else if(4==grafico){const t=1928,r=10,n=10,o=10,s=40;var x=[];radius=t/6,e.anoCurso.forEach(t=>{const e={...t,id:t.id};x.push(e)});const i=x.flatMap(t=>t.asignaturas.map(t=>t.id)),c=x.flatMap(t=>t.asignaturas.flatMap(t=>t.relaciones.map(t=>({source:t.id_asignatura1,target:t.id_asignatura2,descripcion:t.descripcion,tipo:p.color})).filter(t=>i.includes(t.source)&&i.includes(t.target))));var v=x.flatMap(t=>t.asignaturas);function b(t,e,r){return t.map(t=>{const{id:a,numero:n,descripcion:o,asignaturas:s}=t;return{name:n+" "+o,children:k(s,e,r),group:a,padre:!0}})}function a(t){if(t.info&&t.info.length>0){const e=t.info.find(t=>t.idioma===idiomaSeleccionado);if(e&&e.nombre)return e.sigla;const r=t.info[0];if(r&&r.nombre)return r.nombre}return t.asignatura}function k(t,e,r){return t.map(t=>{const{relaciones:n,id:o,asignatura:s,descripcion:i,cursoID:c}=t;nombre=a(t);return{name:nombre,"descripción":i,id:o,padre:!0,children:M(o,e,r),group:c}})}function M(t,e,r){const n=[],o=new Set;return e.filter(e=>e.source===t).forEach(t=>{const{target:s,value:i}=t;var c=function(t,e){const r=e.find(e=>e.id===t);return r||null}(s,r);const l={name:a(c),value:1,group:c.cursoID,padre:!0,children:M(c.id,e,v)};o.has(l.name)||(n.push(l),o.add(l.name))}),n}const l=function(t,e,r){const{nombreCurso:a,universidadCurso:n,anoCurso:o}=t;return{name:a,children:b(o,e,r)}}(e,c,v),g=d3.hierarchy(l);g.each(t=>t.current=t);const f=10,m=(t-n-s)/(1+g.height),h=d3.tree().nodeSize([f,m]),y=d3.linkHorizontal().x(t=>t.y).y(t=>t.x);d.attr("width",t).attr("height",700).attr("viewBox",[-s,-r,t,f]).attr("style","max-width: 100%; height: auto; font: 10px sans-serif; user-select: none;");const w=d.append("g"),E=d3.zoom().scaleExtent([.1,Math.min(t,height)]).on("zoom",()=>{w.attr("transform",d3.event.transform),this.xAxis.call(this.xScale.scale(d3.event.transform.rescaleX(this.xScale))),this.yAxis.call(this.yScale.scale(d3.event.transform.rescaleY(this.yScale)))});d.call(E);const $=w.append("g").attr("fill","none").attr("stroke","#555").attr("stroke-opacity",.4).attr("stroke-width",1.5),L=w.append("g").attr("cursor","pointer").attr("pointer-events","all");return g.x0=m/2,g.y0=0,g.each(t=>{t.x0=t.x,t.y0=t.y}),g.descendants().forEach((t,e)=>{t.id=e,t._children=t.children,t.depth&&7!==t.data.name.length&&(t.children=null)}),g.x0=m/2,g.y0=0,function e(a,n=g){const i=a&&a.altKey?2500:250,c=g.descendants().reverse(),l=g.links();h(g),g.eachBefore(t=>{void 0!==t.x&&void 0!==t.y&&(t.x0=t.x,t.y0=t.y)});let d=g,p=g;g.eachBefore(t=>{t.x<d.x&&(d=t),t.x>p.x&&(p=t)});const f=p.x-d.x+r+o,m=u.transition().duration(i).attr("height",f).attr("viewBox",[-s,d.x-r,t,f]).tween("resize",window.ResizeObserver?null:()=>()=>u.dispatch("toggle")),x=L.selectAll("g").data(c,t=>t.id),v=x.enter().append("g").attr("class","node").attr("transform",t=>`translate(${void 0!==n.y0?n.y0:n.parent?n.parent.y0:0},${void 0!==n.x0?n.x0:n.parent?n.parent.x0:0})`).attr("fill-opacity",0).attr("stroke-opacity",0).on("click",(t,r)=>{t.children?(t._children=t.children,t.children=null):(t.children=t._children,t._children=null),e(r,t)});v.append("circle").attr("r",2.5).attr("fill",t=>t._children?"#555":"#999").attr("stroke-width",10),v.append("text").attr("dy","0.31em").attr("x",t=>t._children?-6:6).attr("text-anchor",t=>t._children?"end":"start").text(t=>t.data&&t.data.name?t.data.name:"prueba").attr("stroke-linejoin","round").attr("stroke-width",3).attr("stroke","white").attr("paint-order","stroke"),x.merge(v).transition(m).attr("transform",t=>`translate(${t.y},${t.x})`).attr("fill-opacity",1).attr("stroke-opacity",1),x.exit().transition(m).remove().attr("transform",t=>`translate(${n.y},${n.x})`).attr("fill-opacity",0).attr("stroke-opacity",0);const b=$.selectAll("path").data(l,t=>t.target.id),k=b.enter().append("path").attr("d",t=>{console.log("Quiero Saber",t);const e={x:n.x0,y:n.y0};return y({source:e,target:e})}).attr("stroke",t=>color(t.target.data.group)).attr("data-value",t=>t.descripcion).attr("data-tipo",t=>t.tipo).on("click",(t,e)=>{e.value&&mostrarInformacion(e)});b.merge(k).transition(m).attr("d",t=>y(t)),b.exit().transition(m).remove().attr("d",t=>{const e={x:n.x,y:n.y};return y({source:e,target:e})}),g.eachBefore(t=>{t.x0=t.x,t.y0=t.y})}(null,g),d.node()}d.node()}function updateGraph(t,e,r,a,n,o,s,i,c,l){const d=t.transition().duration(750);o.on("click",t=>{mostrarGrafico(t,data)});const u=e.reduce((t,e)=>(t[e.curso]||(t[e.curso]=[]),t[e.curso].push(e),t),{}),p=Object.entries(u),g=Object.keys(u).length,f=i.width/g;p.map(([t,e])=>e.length*f);totalWidth=g*f,offsetX=(i.width+150-totalWidth)/2,additionalYOffset=20,p.forEach(([t,e],r)=>{size=e.length,e.forEach((t,e)=>{offsetX=(i.width+150-f)/size,t.y=70*r+additionalYOffset,t.x=70*e+offsetX+10})}),r.transition().delay((t,e)=>20*e).attrTween("transform",t=>{const e=t.x,r=t.y;return t=>`translate(${e},${r})`}),r.select("text").text(t=>t.sigla),t.attr("viewBox",[0,0,i.width,i.height]),s.call(d3.zoom().on("zoom",(function(t){s.attr("transform",t.transform)}))),a.transition(d).delay((t,e)=>20*e).attr("d",l).attr("transform",`translate(${100-c.left},0)`).attr("marker-end",t=>`url(#arrow-${t.source.group}-${t.target.group})`),n.transition(d).delay((t,e)=>20*e).attr("d",l).attrTween("transform",t=>t=>"translate(100,0)").delay((t,e)=>20*e).attr("d",l).attr("transform",`translate(${100-c.left},0)`).attr("marker-end",t=>`url(#arrow-${t.source.group}-${t.target.group})`),o.transition(d).delay((t,e)=>20*e).attr("y",t=>t.y-step/2).attr("x",t=>t.x-c.left)}function miFuncionExterna(t,e,r,a){e.selectAll(".parent-circle").remove(),e.selectAll("*").remove(),e.selectAll(".node").remove(),e.selectAll(".link").remove(),e.selectAll(".label").remove(),e.selectAll(".group-node").remove(),e.append("style").text("\n    .hover path {\n      stroke: transparent;\n    }\n    .hover text {\n      fill: #ccc;\n    }\n    .hover g.primary text {\n      fill: black;\n      font-weight: bold;\n    }\n    .hover g.secondary text {\n      fill: #333;\n    }\n    .hover path.primary {\n      stroke: #333;\n      stroke-opacity: 1;\n    }\n  ");e.attr("viewBox",[0,0,500,700]);const n=e.append("g"),o=d3.zoom().scaleExtent([.1,Math.min(500,700)]).on("zoom",()=>{n.attr("transform",d3.event.transform)});e.call(o);const s=a.filter(e=>e.target.id===t.id);var i=t.sourceLinks,c=t.targetLinks,l=i.concat(c).concat(s),d=new Set;l.forEach((function(t){d.add(t.source),d.add(t.target)}));t.id;var u=new Set,p=[],g=0,f=u.size,m=2*Math.PI/f;u.forEach((function(t){var e=g*m,r=200*Math.cos(e),a=200*Math.sin(e);p.push({id:t,group:t,x:r,y:a,isGroup:!0}),g++}));var h=[];d.forEach((function(t){h.push({id:t.id,nombre:t.nombre,semestre:t.semestre,group:t.group,isGroup:!1})}));var y=l.map((function(t){return{source:t.source.id,target:t.target.id,value:t.value,color:t.color}})),x={nodes:h,links:y};const v=d3.forceSimulation(x.nodes).force("link",d3.forceLink(x.links).id(t=>t.id).distance(400)).force("charge",d3.forceManyBody().strength(-800)).force("center",d3.forceCenter(250,350));var b=n.selectAll(".link").data(x.links).enter().append("line").attr("class","link").attr("stroke","#aaa").attr("stroke-width",(function(t){return Number(t.color)+1.5})).on("mouseover",(function(t){d3.select(this).attr("stroke","red").attr("stroke-width",(function(t){return 4*(Number(t.color)+1)}))})).on("mouseout",(function(t){d3.select(this).attr("stroke","#aaa").attr("stroke-width",(function(t){return 1.5*(Number(t.color)+1)}))})).on("click",t=>{mostrarRelacion(t)}).attr("marker-end",t=>`url(#arrow-${t.source.group}-${t.target.group})`).style("stroke","#aaa"),k=n.selectAll(".node").data(x.nodes.filter(t=>!t.isGroup)).enter().append("circle").attr("class","node").attr("r",15).attr("fill",t=>r(t.group)).on("mouseover",(function(t){})).on("mouseout",t=>{}).on("click",t=>{}),M=n.selectAll(".label").data(x.nodes).enter().append("text").attr("class","label").attr("fill",t=>d3.color(r(t.group)).darker(5)).text(t=>t.nombre);k.call(function(t){return d3.drag().on("start",(function(e){d3.event.active||t.alphaTarget(.3).restart(),e.fx=e.x,e.fy=e.y})).on("drag",(function(t){t.fx=d3.event.x,t.fy=d3.event.y})).on("end",(function(e){d3.event.active||t.alphaTarget(0),e.fx=null,e.fy=null}))}(v)),v.on("tick",()=>{b.attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),k.attr("cx",t=>t.x).attr("cy",t=>t.y),M.attr("x",t=>t.x+10).attr("y",t=>t.y+5)})}function filtrarCursos(){const t=function(){const t=document.querySelectorAll(".activo"),e=[];return t.forEach((function(t){e.push(t.id)})),e}();var e={...res};e.anoCurso=e.anoCurso.filter(e=>t.includes(e.id)),InicializarGrafo(e)}function imprimirTimeLine(t,e,r,a){updateLista()}function imprimirNodos(t,e,r){console.log("aux",t,"svg");var a=[];width=600,radius=width/6,t.anoCurso.forEach(t=>{const e={...t,id:t.id};a.push(e)});const n=a.flatMap(t=>t.asignaturas.map(t=>t.id));function o(t,e,r){return t.map(t=>{const{id:a,numero:n,descripcion:o,asignaturas:s}=t;return{name:n+" "+o,children:i(s,e,r),group:a,padre:!0}})}function s(t){if(t.info&&t.info.length>0){const e=t.info.find(t=>t.idioma===idiomaSeleccionado);if(e&&e.nombre)return e.sigla;const r=t.info[0];if(r&&r.nombre)return r.sigla}return t.asignatura}function i(t,e,r){return t.map(t=>{const{relaciones:a,id:n,asignatura:o,descripcion:i,cursoID:l}=t;nombre=s(t);return{name:nombre,"descripción":i,id:n,padre:!0,children:c(n,e,r),group:l}})}function c(t,e,r){const a=[],n=new Set;return e.filter(e=>e.source===t).forEach(t=>{const{target:o,value:i}=t;var l=function(t,e){const r=e.find(e=>e.id===t);return r||null}(o,r);const d={name:s(l),value:1,group:l.cursoID,padre:!0,children:c(l.id,e,r)};n.has(d.name)||(a.push(d),n.add(d.name))}),a}const l=function(t,e,r){const{nombreCurso:a,universidadCurso:n,anoCurso:s}=t;return{name:a,children:o(s,e,r)}}(t,a.flatMap(t=>t.asignaturas.flatMap(t=>t.relaciones.map(t=>({source:t.id_asignatura1,target:t.id_asignatura2,value:t.descripcion})).filter(t=>n.includes(t.source)&&n.includes(t.target)))),a.flatMap(t=>t.asignaturas)),d=d3.arc().startAngle(t=>Math.max(0,Math.min(2*Math.PI,t.x0))).endAngle(t=>Math.max(0,Math.min(2*Math.PI,t.x1))).padAngle(t=>Math.min((t.x1-t.x0)/2,.005)).padRadius(1.5*radius).innerRadius(t=>t.y0*radius).outerRadius(t=>Math.max(t.y0*radius,t.y1*radius-1)),u=(t=>{const e=t=>{t.children&&0!==t.children.length?t.children.forEach(e):t.value=t.value||1};e(t);const r=d3.hierarchy(t).sum(t=>t.value).sort((t,e)=>e.value-t.value);return d3.partition().size([2*Math.PI,r.height+1])(r)})(l);u.each(t=>t.current=t);const p=e.append("g").attr("transform",`translate(${width/2},${width/2})`),g=d3.zoom().scaleExtent([.1,Math.min(width,height)]).on("zoom",()=>{p.attr("transform",d3.event.transform),this.xAxis.call(this.xScale.scale(d3.event.transform.rescaleX(this.xScale))),this.yAxis.call(this.yScale.scale(d3.event.transform.rescaleY(this.yScale)))});e.call(g);const f=d3.format(",d"),m=p.append("g").selectAll("path").data(u.descendants().slice(1)).enter().append("path").attr("fill",t=>r(t.data.group)).attr("fill-opacity",t=>b(t.current)?t.children?.6:.4:0).attr("d",t=>d(t.current)).filter(t=>t.data.padre).style("cursor","pointer").on("click",v).each((function(t){d3.select(this).transition().on("end",(function(){d3.select(this).append("title").text(t=>`${t.ancestors().map(t=>t.data.name).reverse().join("/")}\n${f(t.value)}`)}))})),h=p.append("g").attr("pointer-events","none").attr("text-anchor","middle").style("user-select","none").selectAll("text").data(u.descendants().slice(1)).enter().append("text").attr("dy","0.35em").attr("fill-opacity",t=>+k(t.current)).attr("transform",t=>M(t.current)).attr("font-size",t=>function(t){const e=(t.x1-t.x0)*(t.y1-t.y0);return e<10||e<100?"10px":"12px"}(t)).text(t=>t.data.name).each((function(t){d3.select(this).append("title").text(t=>`${t.ancestors().map(t=>t.data.name).reverse().join("/")}\n${f(t.value)}`)})).on("mouseover",(function(t){})).on("mouseout",(function(t){})).on("click",t=>{console.log(t)}),y=p.append("circle").datum(u).attr("r",radius).attr("fill","none").attr("pointer-events","all").on("click",()=>v(y.datum())),x=p.append("text").attr("text-anchor","middle").attr("dy","0.35em").text(u.data.name);function v(t){y.datum(t.parent||u),x.text(t.data.name),u.each((function(e){e.target={x0:2*Math.max(0,Math.min(1,(e.x0-t.x0)/(t.x1-t.x0)))*Math.PI,x1:2*Math.max(0,Math.min(1,(e.x1-t.x0)/(t.x1-t.x0)))*Math.PI,y0:Math.max(0,e.y0-t.depth),y1:Math.max(0,e.y1-t.depth)}}));const e=p.transition().duration(750);m.transition(e).tween("data",(function(t){const e=d3.interpolate(t.current,t.target);return function(r){t.current=e(r)}})).filter((function(t){return+this.getAttribute("fill-opacity")||b(t.target)})).attr("fill-opacity",(function(t){return b(t.target)?t.children?.6:.4:0})).attrTween("d",(function(t){return function(){return d(t.current)}})),h.filter((function(t){return this.getAttribute("fill-opacity")||k(t.target)})).transition(e).attr("fill-opacity",t=>+k(t.target)).attrTween("transform",t=>()=>M(t.current))}function b(t){return t&&t.y1<=3&&t.y0>=1&&t.x1>t.x0}function k(t){return t.y1<=3&&t.y0>=1&&(t.y1-t.y0)*(t.x1-t.x0)>.03}function M(t){const e=(t.x0+t.x1)/2*(180/Math.PI);return`rotate(${e-90}) translate(${(t.y0+t.y1)/2*radius},0) rotate(${e<180?0:180})`}}function imprimirTodosNodos(t,e,r){data=t.anoCurso,e.selectAll(".node").remove(),e.selectAll(".link").remove(),e.selectAll(".label").remove(),e.selectAll(".group-node").remove();var a=[],n=0,o=data.length,s=2*Math.PI/o;const i={};function c(t){if(t.info&&t.info.length>0){const e=t.info.find(t=>t.idioma===idiomaSeleccionado);if(e&&e.nombre)return e.nombre;const r=t.info[0];if(r&&r.nombre)return r.nombre}return t.asignatura}data.forEach((function(t){var e=n*s,r=200*Math.cos(e),o=200*Math.sin(e);i[t.id]=r,a.push({id:t.id,group:t.descripcion,x:r,y:o,isGroup:!0}),n++}));var l=[];function d(t){if(t.info&&t.info.length>0){const e=t.info.find(t=>t.idioma===idiomaSeleccionado);if(e&&e.nombre)return e.sigla;const r=t.info[0];if(r&&r.nombre)return r.sigla}return t.asignatura}asignaturas=data.flatMap(t=>t.asignaturas.map(t=>c(t))),l=data.flatMap(t=>t.asignaturas.map(t=>({id:t.id,nombre:c(t),sigla:d(t),url:t.url,semestre:t.semestre,descripcion:t.descripcion,sourceLinks:[],targetLinks:[],group:t.cursoID,tags:t.tags,isGroup:!1})));const u=new Map(l.map(t=>[t.id,t])),p=data.flatMap(t=>t.asignaturas.flatMap(t=>t.relaciones.map(t=>({source:u.get(t.id_asignatura1),target:u.get(t.id_asignatura2),color:t.color,value:t.descripcion})))).filter(t=>void 0!==t.target);for(const t of p){const{source:e,target:r,value:a}=t;e.sourceLinks.push(t),r.targetLinks.push(t)}var g=[];const f={allnodes:l.concat(a),allinks:p.concat(g).concat([])};e.attr("viewBox",[0,0,500,700]);const m=e.append("g"),h=d3.zoom().scaleExtent([.1,Math.min(500,700)]).on("zoom",()=>{m.attr("transform",d3.event.transform),this.xAxis.call(this.xScale.scale(d3.event.transform.rescaleX(this.xScale))),this.yAxis.call(this.yScale.scale(d3.event.transform.rescaleY(this.yScale)))});e.call(h);const y=d3.forceSimulation(f.allnodes).force("link",d3.forceLink(g).id(t=>t.id).distance(10)).force("charge",d3.forceManyBody().strength(-30)).force("center",d3.forceCenter(250,350));var x=m.selectAll(".link").data(f.allinks).enter().append("line").attr("class","link").attr("stroke","#aaa").attr("stroke-width",12).attr("stroke-width",(function(t){return Number(t.color)+1.5})).on("mouseover",(function(t){d3.select(this).attr("stroke","red").attr("stroke-width",(function(t){return 4*(Number(t.color)+1)}))})).on("mouseout",(function(t){d3.select(this).attr("stroke","#aaa").attr("stroke-width",(function(t){return 1.5*(Number(t.color)+1)}))})).on("click",t=>{mostrarRelacion(t)}).attr("marker-end",t=>`url(#arrow-${t.source.group}-${t.target.group})`).style("stroke","#aaa").attr("x1",(function(t){return t.source.x})).attr("y1",(function(t){return t.source.y})).attr("x2",(function(t){var e=t.target.x-t.source.x,r=t.target.y-t.source.y,a=Math.sqrt(e*e+r*r);return t.target.x-e/a*15})).attr("y2",(function(t){var e=t.target.x-t.source.x,r=t.target.y-t.source.y,a=Math.sqrt(e*e+r*r);return t.target.y-r/a*15}));data.forEach(t=>{t.asignaturas.forEach(t=>{t.relaciones.forEach(t=>{e.append("defs").append("marker").attr("id",`arrow-${t.id_asignatura1}-${t.id_asignatura2}`).attr("viewBox","0 -5 10 10").attr("refX",5).attr("refY",0).attr("markerWidth",30).attr("markerHeight",30).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("fill","#000")})})});var v=m.selectAll(".group-node").data(f.allnodes.filter(t=>t.isGroup)).enter().append("rect").attr("class","group-node").attr("width",15).attr("height",15).attr("fill",t=>r(t.group)).call(M(y)),b=m.selectAll(".label").data(f.allnodes).enter().append("text").attr("class","label").style("font-size","10px").style("opacity","0.8").attr("fill",t=>d3.color(r(t.group)).darker(5)).text(t=>t.nombre);e.selectAll(".group-node").remove();var k=m.selectAll(".node").data(f.allnodes.filter(t=>!t.isGroup)).enter().append("g").append("circle").attr("r",15).attr("class","node").on("mouseover",(function(t){d3.select(this).attr("r",20);const e=new Set,r=new Set(t.sourceLinks.map(t=>t.target.nombre));t.sourceLinks.forEach(t=>{e.add(t.target)}),t.targetLinks.forEach(t=>{e.add(t.source)}),t.targetLinks.forEach(t=>r.add(t.source.nombre));const a=Array.from(r);x.style("stroke",(function(e){return e.source.nombre===t.nombre||e.target.nombre===t.nombre?"black":"#f0f0f0"}));for(const e of b._groups[0])a.includes(e.textContent)?d3.select(e).style("font-weight","bold").style("font-size","22px"):e.textContent==t.nombre?d3.select(e).style("font-weight","bold").style("font-size","31px"):d3.select(e).style("color","#ccc").style("opacity","0.4");e.forEach(e=>{d3.select(e).transition().duration(2e3).attr("cx",t.x).attr("cy",t.y)}),t.sourceLinks.forEach(e=>{d3.select(e).transition().duration(2e3).attr("x1",t.x).attr("y1",t.y)}),t.targetLinks.forEach(e=>{d3.select(e).transition().duration(2e3).attr("x2",t.x).attr("y2",t.y)})})).on("mouseout",t=>{for(const t of b._groups[0])d3.select(t).style("font-weight","normal").style("font-size","14px").style("color","black").style("opacity","0.8");m.selectAll(".node").attr("r",15),x.style("stroke","#aaa")}).on("click",t=>{console.log(t,data),mostrarGrafico(t,data)}).attr("fill",t=>r(t.group)).call(M(y));function M(t){return d3.drag().on("start",(function(e){d3.event.active||t.alphaTarget(.3).restart(),e.fx=e.x,e.fy=e.y})).on("drag",(function(t){t.fx=d3.event.x,t.fy=d3.event.y})).on("end",(function(e){d3.event.active||t.alphaTarget(0),e.fx=null,e.fy=null}))}y.on("tick",()=>{x.attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",(function(t){var e=t.target.x-t.source.x,r=t.target.y-t.source.y,a=Math.sqrt(e*e+r*r);return t.target.x-e/a*15})).attr("y2",(function(t){var e=t.target.x-t.source.x,r=t.target.y-t.source.y,a=Math.sqrt(e*e+r*r);return t.target.y-r/a*15})),k.attr("cx",t=>t.x).attr("cy",t=>t.y),v.attr("x",t=>t.x-10).attr("y",t=>t.y-10),b.attr("x",t=>t.x+28).attr("y",t=>t.y+5)})}obtenerGrafo(proyecto.id);const contenedor=document.querySelector(".grafico"),izquierdo=document.querySelector(".canvas"),derecho=document.querySelector(".panel"),expandirButton=document.getElementById("expandir-button");let izquierdoVisible=!0;function disperseCanvas(){izquierdoVisible?(document.getElementById("disperse-button").textContent="<",izquierdo.style.flex="0",derecho.style.flex="1"):(document.getElementById("disperse-button").textContent="<",izquierdo.style.flex="1",derecho.style.flex="1"),izquierdoVisible=!izquierdoVisible}function disperseGrafico(){izquierdoVisible?(document.getElementById("disperse-button").textContent="<",izquierdo.style.flex="1",derecho.style.flex="0"):(document.getElementById("disperse-button").textContent="<",izquierdo.style.flex="1",derecho.style.flex="1"),izquierdoVisible=!izquierdoVisible}function crearRelaciones(t){for(let e=0;e<t.length;e++){const r=t[e];for(let a=e+1;a<t.length;a++){const e=t[a],n=encontrarTagsComunes(r.tags,e.tags);n.length>0&&(r.relacionesTag.push({id:e.id,tagsComunes:n}),e.relacionesTag.push({id:r.id,tagsComunes:n}))}}}function encontrarTagsComunes(t,e){const r=[];for(const a of t)for(const t of e)a.descripcion===t.descripcion&&r.push(a.descripcion);return r}function mostrarTags(t){const e=document.createElement("div");e.classList.add("modalTags"),e.innerHTML='\n    <form class="formulario nueva-tarea">\n        <legend>Lista de Tags</legend>\n       \n        <div class="modal-content">\n            \n            <h2></h2>\n            <input type="text" id="buscarTag" value="-1" placeholder="Buscar tag">\n            <div id="listaTagsModal" class="listaTagsModal">\n            <label>\n            <input type="checkbox" id="checkboxTodos" value="todos"> Todos\n          </label>\n                </div>\n           \n        </div>\n    \n        \n    <div class="opciones">\n    <button type="button" class="submit-nueva-tarea" > Filtrar Tags</button>\n    <button type="button" class="cerrar-modal">Cancelar</button>\n    </div>    \n    </form>\n    ',document.body.appendChild(e);const r=document.getElementById("buscarTag");e.querySelector("#listaTagsModal");t.forEach(t=>{const e=document.createElement("div");e.classList.add("tag-container");const r=document.createElement("input");r.type="checkbox";r.value=t,r.classList.add("tag"),tagsSeleccionados.includes(t)&&(r.checked=!0);const a=document.createElement("label");a.classList.add("tag-label"),a.textContent=t,e.appendChild(r),e.appendChild(a);document.getElementById("listaTagsModal").appendChild(e)});const a=document.getElementById("checkboxTodos"),n=document.querySelectorAll(".tag");a.addEventListener("click",(function(){a.checked&&(tagsFiltro=["-1"],n.forEach(t=>{t.checked=!1}))})),n.forEach(t=>{t.addEventListener("click",(function(){t.checked?tagsSeleccionados.push(t.value):tagsSeleccionados=tagsSeleccionados.filter(e=>e!==t.value),a.checked=!1}))}),r.addEventListener("keyup",(function(t){const e=t.target.value.toLowerCase();document.querySelectorAll(".tag-container").forEach(t=>{t.querySelector(".tag-label").textContent.toLowerCase().includes(e)?t.classList.remove("filtro"):t.classList.add("filtro")})})),e.addEventListener("click",(function(t){if(t.target.classList.contains("tag")){const e=t.target;e.value,e.checked}if(t.target.classList.contains("cerrar-modal")){document.querySelector(".formulario").classList.add("cerrar"),setTimeout(()=>{e.remove()},150)}if(t.target.classList.contains("submit-nueva-tarea")){if(document.querySelector(".formulario").classList.add("cerrar"),tagsFiltro=[],n.forEach(t=>{t.checked&&tagsFiltro.push(t.value)}),tagsSeleccionados.length>0){const t=JSON.parse(JSON.stringify(data));aux={...res},Array.isArray(t)&&aux.anoCurso.forEach(t=>{Array.isArray(t.asignaturas)&&(t.asignaturas=t.asignaturas.filter(t=>{let e=!1;for(let r of t.tags)if(tagsFiltro.includes(r.descripcion)){e=!0;break}return e}))}),InicializarGrafo(aux)}else location.reload();setTimeout(()=>{e.remove()},150)}})),document.querySelector(".dashboard").appendChild(e);document.getElementById("contenido")}function imprimirNodoColumna(t,e,r){const a=t.anoCurso.flatMap(t=>t.asignaturas.map(t=>n(t)));function n(t){if(t.info&&t.info.length>0){const e=t.info.find(t=>t.idioma===idiomaSeleccionado);if(e&&e.nombre)return e.nombre;const r=t.info[0];if(r&&r.nombre)return r.nombre}return t.asignatura}dx=3*d3.max(a,t=>t.length)+d3.max(a,t=>t.length)/1,height=(t.anoCurso.flatMap(t=>t.asignaturas).length-1)*step+margin.top+margin.bottom;const o=t.anoCurso.flatMap(t=>t.asignaturas.map(t=>({id:t.id,nombre:n(t),sigla:n,url:t.url,semestre:t.semestre,sourceLinks:[],targetLinks:[],group:t.cursoID,tags:t.tags}))),s=[];for(let t=0;t<o.length;t++)for(let e=t+1;e<o.length;e++){const r=o[t].tags.map(t=>t.descripcion),a=o[e].tags.map(t=>t.descripcion);r.filter(t=>a.includes(t)).length>0&&s.push({source:o[t],target:o[e]})}const i=new Map(o.map(t=>[t.id,t])),c=t.anoCurso.flatMap(t=>t.asignaturas.flatMap(t=>t.relaciones.map(t=>({source:i.get(t.id_asignatura1),target:i.get(t.id_asignatura2),value:t.descripcion})))).filter(t=>void 0!==t.target);for(const t of c){const{source:e,target:r,value:a}=t;e.sourceLinks.push(t),r.targetLinks.push(t)}const l={nodes:o,links:c};escalax=d3.scaleLinear().domain([0,dx]).range([0,margin.left]),d3.select(".panel").select("svg").remove(),d3.select(".canvas").select("svg").remove();const d=d3.select(".canvas").append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${dims.width} ${dims.height}`).attr("preserveAspectRatio","xMidYMid meet");d.append("style").text("\n          .hover path {\n            stroke: transparent;\n          }\n          .hover text {\n            fill: #ccc;\n          }\n          .hover g.primary text {\n            fill: black;\n            font-weight: bold;\n          }\n          .hover g.secondary text {\n            fill: #333;\n          }\n          .hover path.primary {\n            stroke: #333;\n            stroke-opacity: 1;\n          }\n        ");const u=d3.scalePoint().domain(l.nodes.map(t=>t.id).sort(d3.ascending)).range([margin.top,height-margin.bottom]);setColor||(r=d3.scaleOrdinal().domain(l.nodes.map(t=>t.group).sort(d3.ascending)).range(d3.schemeCategory10),setColor=!0);const p=d.append("g").attr("font-family","sans-serif").attr("font-size",8).attr("text-anchor","end").selectAll("g").data(l.nodes).enter().append("g").attr("transform",t=>`translate(${dx}, ${t.y=u(t.id)})`);p.append("text").attr("x",-6).attr("class","prueba").attr("dy","0.35em").attr("fill",t=>d3.lab(r(t.group)).darker(2)).text(t=>t.nombre),p.append("circle").attr("r",3).attr("fill",t=>r(t.group));const g=d.insert("g","*").attr("fill","none").attr("class","relacion").attr("stroke-opacity",.6).attr("stroke-width",1.5).selectAll("path").data(l.links).enter().append("path").attr("stroke",t=>t.source.group===t.target.group?r(t.source.group):r(t.target.group)).attr("d",(function(t){const e=t.source.y,r=t.target.y,a=Math.abs(r-e)/1.7;return`M${margin.left},${e}A${a},${a} 0,0,${e<r?1:0} ${margin.left},${r}`})).attr("transform",`translate(${dx-margin.left},0)`);d.insert("g","*").attr("fill","none").attr("class","relacion").attr("stroke-opacity",.6).attr("stroke-width",1.5).selectAll("path").data(s).enter().append("path").attr("stroke",t=>t.source.group===t.target.group?r(t.source.group):r(t.target.group)).attr("d",(function(t){const e=t.source.y,r=t.target.y,a=Math.abs(r-e)/1.7;return`M${margin.left},${e}A${a},${a} 0,0,${e<r?1:0} ${margin.left},${r}`})).attr("transform",`translate(${dx-margin.left},0)`),d.append("g").attr("fill","none").attr("pointer-events","all").selectAll("rect").data(l.nodes).enter().append("rect").attr("width",margin.left+40).attr("height",step).attr("y",t=>u(t.id)-step/2).attr("x",dx-margin.left).on("mouseover",(function(t){d.classed("hover",!0),p.classed("primary",e=>e===t),p.classed("secondary",e=>e.sourceLinks.some(e=>e.target===t)||e.targetLinks.some(e=>e.source===t)),g.classed("primary",e=>e.source===t||e.target===t).filter(".primary").raise()})).on("mouseout",t=>{d.classed("hover",!1),p.classed("primary",!1),p.classed("secondary",!1),g.classed("primary",!1).order()}).on("click",(function(t){}));d.node()}document.getElementById("disperse-button").addEventListener("click",disperseCanvas);